name: 'Claude Code PR Review'
description: 'Composite action for automated PR review using Claude Code with AWS Bedrock'
author: 'Anthropic'
branding:
  icon: 'check-circle'
  color: 'orange'

inputs:
  custom_review_instructions:
    description: 'Custom review instructions to append to the base prompt'
    required: false
    default: ''
  prompt:
    description: 'Optional prompt to use for the review. If "prompt_file" is also set, that will be used instead.'
    required: false
    default: ''
  prompt_file:
    description: 'Optional file that contains the prompt to use for the review. This takes priority over "prompt".'
    required: false
    default: ''
  disallowed_tools:
    description: 'Comma-separated list of tools to disallow during the review'
    required: false
    default: ''
  trigger_phrase:
    description: 'The trigger phrase to look for in comments, issue body, or pull request body'
    required: false
    default: '@claude'
  aws_role_arn:
    description: 'AWS IAM role ARN to assume for Bedrock access'
    required: true

runs:
  using: 'composite'
  steps:
  - name: Validate caller workflow
    shell: bash
    run: |
      set -euo pipefail

      WORKFLOW_REF="${{ github.workflow_ref }}"

      # Check if called from authorized workflows in auth0 or openfga orgs
      if [[ "$WORKFLOW_REF" == *"auth0/ai-pr-analyzer-gh-action/.github/workflows/"* ]]; then
        echo "Authorized workflow detected: $WORKFLOW_REF"
        exit 0
      fi

      echo "::error::This action must be called via the official reusable workflow."
      echo "::error::Use: uses: auth0/ai-pr-analyzer-gh-action/.github/workflows/claude-code-review.yml@main"
      echo ""
      echo "Detected workflow_ref: $WORKFLOW_REF"
      exit 1

  - name: Get PR info for fork support
    if: github.event.issue.pull_request
    id: pr-info
    shell: bash
    env:
      GH_TOKEN: ${{ github.token }}
    run: |
      PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
      echo "pr_head_owner=$(echo "$PR_DATA" | jq -r '.head.repo.owner.login')" >> $GITHUB_OUTPUT
      echo "pr_head_repo=$(echo "$PR_DATA" | jq -r '.head.repo.name')" >> $GITHUB_OUTPUT
      echo "pr_head_ref=$(echo "$PR_DATA" | jq -r '.head.ref')" >> $GITHUB_OUTPUT
      echo "is_fork=$(echo "$PR_DATA" | jq -r '.head.repo.fork')" >> $GITHUB_OUTPUT

  - name: Checkout code
    uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    with:
      repository: ${{ github.event.issue.pull_request && steps.pr-info.outputs.is_fork == 'true' && format('{0}/{1}', steps.pr-info.outputs.pr_head_owner, steps.pr-info.outputs.pr_head_repo) || github.event.pull_request.head.repo.full_name || github.repository }}
      ref: ${{ github.event.issue.pull_request && steps.pr-info.outputs.pr_head_ref || github.event.pull_request.head.ref || github.ref }}
      fetch-depth: 0

  - name: Copy Claude config to home directory
    shell: bash
    run: |
      set -e

      if [ -d "${GITHUB_ACTION_PATH}/.claude" ]; then
        echo "Copying Claude config from ${GITHUB_ACTION_PATH}/.claude to ~/.claude"
        cp -r "${GITHUB_ACTION_PATH}/.claude" ~/.claude
        ls -la ~/.claude/agents
        echo "Claude config copied successfully"
      else
        echo "No .claude directory found at ${GITHUB_ACTION_PATH}/.claude - skipping agent setup"
        exit 1
      fi

  - name: Check for symlinks
    shell: bash
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: "${{ github.event.issue.number || github.event.pull_request.number }}"
      GH_REPO: ${{ github.repository }}
    run: ${GITHUB_ACTION_PATH}/scripts/check-symlinks.sh

  - name: Get diff
    id: get-diff
    shell: bash
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: "${{ github.event.issue.number || github.event.pull_request.number }}"
      GH_REPO: ${{ github.repository }}
    run: ${GITHUB_ACTION_PATH}/scripts/diff.sh

  - name: Create Claude Prompt
    id: claude_prompt
    shell: bash
    env:
      DIFF_FILE: ${{ steps.get-diff.outputs.DIFF_FILE }}
      INPUT_FILE: ${{ inputs.prompt_file }}
      INPUT_PROMPT: ${{ inputs.prompt }}
      INPUT_CUSTOM_REVIEW_INSTRUCTIONS: ${{ inputs.custom_review_instructions }}
    run: |
      set -euo pipefail

      # Write specific inputs to files to avoid escaping issues with shell arguments
      if [ -n "${INPUT_PROMPT}" ]; then
        printf '%s\n' "${INPUT_PROMPT}" > /tmp/inputs_prompt
      fi
      if [ -n "${INPUT_CUSTOM_REVIEW_INSTRUCTIONS}" ]; then
        printf '%s\n' "${INPUT_CUSTOM_REVIEW_INSTRUCTIONS}" > /tmp/inputs_custom_review_instructions
      fi

      # Render prompt and store it in /tmp/prompt.md
      "${GITHUB_ACTION_PATH}/scripts/create-prompt.sh" \
        "${GITHUB_WORKSPACE}" \
        "${GITHUB_ACTION_PATH}" \
        "${INPUT_FILE}" \
        "/tmp/inputs_prompt" \
        "/tmp/inputs_custom_review_instructions" \
        "/tmp/prompt.md" \
        "${DIFF_FILE}"

      # Write the final prompt to GitHub Outputs using the multi-line syntax
      {
        echo 'prompt<<EOF'
        cat /tmp/prompt.md
        echo EOF
      } >> $GITHUB_OUTPUT

  - name: Hide Previous Reviews
    shell: bash
    if: |
      (github.event_name == 'issue_comment' && github.event.comment.body == '@claude') || 
      (github.event_name == 'pull_request_review' && github.event.review.body == '@claude')
    env:
      GH_TOKEN: ${{ github.token }}
      PR_NUMBER: "${{ github.event.issue.number || github.event.pull_request.number }}"
      GH_REPO: ${{ github.repository }}
    run: ${GITHUB_ACTION_PATH}/scripts/hide-previous-reviews.sh

  - name: Set up Python
    uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
    with:
      python-version: '3.11'

  - name: Install uv
    shell: bash
    run: |
      python -m pip install --upgrade pip
      python -m pip install uv==0.6.11
      uv --version

  - name: Configure AWS Credentials (OIDC)
    uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
    with:
      role-to-assume: ${{ inputs.aws_role_arn }}
      role-session-name: bedrock-pr-analyzer
      aws-region: us-east-1

  - name: Trigger Claude Code
    uses: anthropics/claude-code-action@fe72061e16b21385cdd53bf2ce3fef01aac24e22  # Claude Code v2.1.20
    with:
      use_bedrock: 'true'
      track_progress: 'true'
      github_token: ${{ github.token }}
      trigger_phrase: ${{ inputs.trigger_phrase }}
      settings: |
        {
          "sandbox": {
            "enabled": true,
            "autoAllowBashIfSandboxed": true,
            "excludedCommands": [],
            "allowUnsandboxedCommands": false,
            "network": {
              "allowLocalBinding": false
            }
          },
          "env": {
            "CLAUDE_CODE_SUBAGENT_MODEL": "global.anthropic.claude-haiku-4-5-20251001-v1:0",
            "ANTHROPIC_DEFAULT_HAIKU_MODEL": "global.anthropic.claude-haiku-4-5-20251001-v1:0"
          }
        }
      claude_args: |
        --model global.anthropic.claude-opus-4-5-20251101-v1:0
        --add-dir ${{ steps.get-diff.outputs.DIFF_DIR }}
        --allowedTools "Bash(git status:*),
          Bash(git log:*),
          Bash(ls:*),
          Bash(printf:*),
          Bash(cat ${{ steps.get-diff.outputs.DIFF_FILE }}),
          Glob,
          Grep,
          LS,
          Read,
          mcp__github_inline_comment"
        --disallowedTools "Bash(git diff:*),
          Bash(gh pr diff:*),
          Bash(git commit:*),
          Bash(git reset:*),
          Bash(git clone:*),
          Bash(env:*),
          Bash(printenv:*),
          Bash(export:*),
          Bash(cat /proc*),
          Bash(cat /sys*),
          Bash(cat /etc*),
          Bash(cat /dev*),
          Bash(cat /root*),
          Bash(cat /tmp*),
          Bash(cat /var*),
          Bash(cat .git*),
          Bash(ls /proc*),
          Bash(ls /sys*),
          Bash(ls /etc*),
          Bash(ls /dev*),
          Bash(ls /home*),
          Bash(ls /root*),
          Bash(ls /tmp*),
          Bash(ls /var*),
          Bash(ls .git*),
          Glob(.git/**),
          Glob(**/.git/**),
          Read(/proc/**),
          Read(/proc/self/**),
          Read(/proc/*/environ),
          Read(/proc/[0-9]*/**),
          Read(/sys/**),
          Read(/etc/**),
          Read(/dev/**),
          Read(/home/**),
          Read(/root/**),
          Read(/var/**),
          Read(/tmp/**),
          Read(.git/**),
          Read(**/.git/**),
          Edit,
          MultiEdit,
          Write,
          Read(vendor),
          Read(package-lock.json),
          Read(dist),
          ${{ inputs.disallowed_tools != '' && format('{0}', inputs.disallowed_tools) || '' }}"
      prompt: ${{ steps.claude_prompt.outputs.prompt }}
